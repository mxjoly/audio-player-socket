<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Formation Musicale - Enregistrements audio</title>
    <style>
      * {
        margin: 0;
        padding: 0;
      }

      body {
        text-align: center;
        display: flex;
        flex-direction: column;
        justify-items: center;
        align-items: center;
        font-family: 'Avenir', sans-serif;
      }

      h1 {
        margin: 30px;
      }

      h2 {
        margin: 5px;
      }

      a {
        text-decoration: none;
        font-style: italic;
      }

      #audio-player {
        margin: 10px;
        width: 75%;
        outline: none;
      }

      #playlist {
        display: flex;
        margin: 30px;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        border: 1px solid black;
        padding: 20px;
        border-radius: 10px;
      }

      ol > li {
        text-align: left;
        margin: 10px;
      }
    </style>
  </head>
  <body>
    <h1>Formation Musicale</h1>

    <audio
      controls
      id="audio-player"
      preload="true"
      type="audio/mp3"
      src="/music/grieg.mp3"
      onplay="start(this)"
      onpause="resume(this)"
      onseeking="changeTime(this)"
    ></audio>

    <div id="playlist">
      <h2>Enregistrements audio</h2>
      <ol id="track-list">
        <li>
          <a href="#" data-idx="0" class="music">
            <dd>1C1 - Grieg, Dance arabe</dd>
          </a>
        </li>
        <li>
          <a href="#" data-idx="1" class="music">
            <dd>1C2 - Mahler, Symphonie n°1, 3ème mouvement</dd>
          </a>
        </li>
      </ol>
    </div>

    <footer>
      <a>@Maxime Joly</a>
    </footer>

    <script src="/main.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      var socket = io();
      var player = document.querySelector('#audio-player');

      socket.on('play', (data) => {
        if (data.src !== player.currentSrc) {
          player.src = data.src;
        }
        if (player.currentTime !== data.time) {
          player.currentTime = data.time;
        }
        player.play();
      });

      socket.on('pause', (data) => {
        if (player.currentTime !== data.time) {
          player.currentTime = data.time;
        }
        if (player.paused === false) {
          player.pause();
        }
      });

      socket.on('change', (data) => {
        if (player.currentTime !== data.time) {
          player.currentTime = data.time;
        }
      });

      function emitEvent(event, control) {
        if (window.location.search.includes('?admin=true')) {
          return socket.emit(event, {
            src: control.src,
            time: control.currentTime,
          });
        }
      }

      function start(control) {
        return emitEvent('play', control);
      }

      function resume(control) {
        return emitEvent('pause', control);
      }

      function changeTime(control) {
        return emitEvent('change', control);
      }

      // Playlist is an array of 5 songs.²
      var playlist = ['grieg.mp3', 'mahler.mp3'];

      // A delegated click event is on each li.song
      // when triggered the following happens:
      var musics = document
        .getElementsByClassName('music')[0]
        .addEventListener('click', (e) => uptadePlayer(e, 0));

      var musics = document
        .getElementsByClassName('music')[1]
        .addEventListener('click', (e) => uptadePlayer(e, 1));

      var uptadePlayer = function (e, idx) {
        e.preventDefault();
        // This url is the location where the mp3s reside.¹
        var base = '/music/';
        player.src = base + playlist[idx];
        player.load();
        player.play();
      };
    </script>
  </body>
</html>
